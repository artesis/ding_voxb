<?php
/**
 * @file
 *
 */

// Define reviews per page
define('VOXB_DEFAULT_REVIEWS_PER_PAGE', 3);
// Define path to Voxb module
define('VOXB_PATH', drupal_get_path('module', 'ding_voxb'));

/**
 * Implements hook_init().
 */
function ding_voxb_init() {
  drupal_add_library('system', 'drupal.ajax');
  drupal_add_library('system', 'jquery.form');
}

/**
 * Implements hook_menu().
 */
function ding_voxb_menu() {
  $items = array();

  $items['admin/config/ding/voxb'] = array(
    'title' => 'VoxB',
    'description' => 'VoxB module settings',
    'page callback' => 'drupal_get_form',
    'page arguments' => array('ding_voxb_admin'),
    'access arguments' => array('access administration pages'),
    'file' => 'ding_voxb.admin.inc'
  );

  $items['voxb/ajax/reviews/%/page/%'] = array(
    'title' => 'VoxB pagination handler',
    'description' => '',
    'page arguments' => array(1, 3, 5),
    'type' => MENU_CALLBACK,
    'access arguments' => array('search content'),
    'page callback' => 'ding_voxb_paginator',
  );

  $items['voxb/ajax/rating/%/%'] = array(
    'title' => 'VoxB rating handler',
    'description' => '',
    'page arguments' => array(1, 3, 4),
    'type' => MENU_CALLBACK,
    'access arguments' => array('search content'),
    'page callback' => 'ding_voxb_rating',
  );

  $items['voxb/ajax/details'] = array(
    'title' => 'VoxB ting objects details handler',
    'description' => '',
    'type' => MENU_CALLBACK,
    'access arguments' => array('search content'),
    'page callback' => 'ding_voxb_details',
  );

  return $items;
}

/**
 * Implements hook_user_login().
 *
 * Invokes methos to select user information from Voxb
 */
function ding_voxb_user_login($edit, $account) {
  $obj = new VoxbLogin();
  $obj->login($account);
}

/**
 * Handle the pagination page click, update reviews & pagination labels
 *
 * @param $type
 *   Type of the request, e.g. ajax or else
 * @param $faust_number
 *   Item ID
 * @param $page
 *   Clicked page number
 */
function ding_voxb_paginator($type = 'ajax', $faust_number = '', $page = 1) {
  // In case we have an ajax call
  if ($type == 'ajax') {
    if ($faust_number != '') {
      // Calculate the reviews array fetch limits
      $per_page = variable_get('voxb_reviews_per_page', VOXB_DEFAULT_REVIEWS_PER_PAGE);
      $start = ($page - 1) * $per_page;
      $end = $start + $per_page;

      // Get the reviews
      $item = new VoxbItem();
      $item->addReviewHandler('review', new VoxbReviews());
      $item->fetchByFaust($faust_number);
      $reviews = $item->getReviews('review')->toArray();

      // Remove the reviews
      $commands[] = ajax_command_html('.user-reviews', '');

      // Place the reviews
      for ($i = $start; $i < $end; $i++) {
        if (isset($reviews[$i]['text'])) {
          $commands[] = ajax_command_append('.user-reviews', theme(
            'voxb_review_record',
            array(
              'author' => $reviews[$i]['authorName'],
              'review' => $reviews[$i]['text'])));
        }
      }

      $page_to_set = 1;
      // Update the pagination 'previous' link
      if ($page > 1) {
        $page_to_set = $page - 1;
      }

      $commands[] = ajax_command_html(
        '.prev-page',
        l(
          '<<',
          'voxb/ajax/reviews/' . $faust_number . '/page/' . $page_to_set . '',
          array('attributes' => array('class' => array('use-ajax')))));

      $pages_total = ceil(count($reviews) / $per_page);
      $page_to_set = $pages_total;

      // Update the pagination 'next' link
      if ($page < $pages_total) {
        $page_to_set = $page + 1;
      }

      $commands[] = ajax_command_html(
        '.next-page',
        l(
          '>>',
          'voxb/ajax/reviews/' . $faust_number . '/page/' . $page_to_set . '',
          array('attributes' => array('class' => array('use-ajax')))));

      // Update the pagination 'numbered' links
      for ($i = $page - 1, $k = 0; $k < 5; $i++, $k++) {
        $page_link = $i - 1;

        // Check the link index bounds, recreate if true, remove if otherwise
        if ($page_link > 0 && $page_link <= $pages_total) {
          $commands[] = ajax_command_html(
            '.page-num:eq(' . $k . ')',
            l(
              $page_link,
              'voxb/ajax/reviews/' . $faust_number . '/page/' . $page_link . '',
              array('attributes' => array('class' => array('use-ajax')))));
        }
        else {
          $commands[] = ajax_command_html('.page-num:eq(' . $k . ')', l('', '', array()));
        }
      }

      $result = array('#type' => 'ajax', '#commands' => $commands);

      // Show the changes
      ajax_deliver($result);
    }
  }
}

/**
 * Implements hook_theme().
 */
function ding_voxb_theme() {
  $hooks['voxb'] = array(
    'variables' => array('object_id' => NULL),
    'template' => 'ding_voxb',
  );

  $hooks['voxb_tag_record'] = array(
    'variables' => array('tag_name' => NULL),
    'template' => 'ding_voxb-tag-record',
  );

  $hooks['voxb_review_record'] = array(
    'variables' => array('author' => NULL, 'review' => NULL),
    'template' => 'ding_voxb-review-record',
  );

  return $hooks;
}

/**
 * Implements MODULE_preprocess_THEME().
 *
 * Enrich ting item landing page with VoxB data.
 */
function ding_voxb_preprocess_voxb(&$variables) {

  drupal_add_css(VOXB_PATH . '/css/voxb-pager.css');
  drupal_add_css(VOXB_PATH . '/css/voxb.css');
  drupal_add_js(VOXB_PATH . '/js/cyclic.fade.js');
  drupal_add_js(VOXB_PATH . '/js/voxb.item.js');

  // Since the theme only read the ting object, further data is gathered next
  $obj_id = $variables['object_id'];

  // Fetch data from VoxB service
  $voxb_item = new VoxbItem();
  $voxb_item->addReviewHandler('review', new VoxbReviews());
  $voxb_item->fetchByFaust($obj_id);
  $profile = unserialize($_SESSION['voxb']['profile']);

  // Tags section
  $tags = '';
  foreach ($voxb_item->getTags() as $v) {
    $tags .= theme('voxb_tag_record', array('tag_name' => $v->getName()));
  }

  // Tags form section
  $tags_form = '';
  if (($profile && $profile->isAbleToTag($obj_id))) {
    $tags_form = drupal_render(drupal_get_form('ding_voxb_tag_form', $obj_id));
  }

  // Rating section
  $ratings = '';
  $rating = (int)$voxb_item->getRating() / 20;

  $ratings .= '<div class="add-rating-container">';
  $ratings .= '<div' . ($profile && $profile->isAbleToRate($obj_id) ? ' class="user-rate"' : '') . '>';

  // Add 'stars'
  for ($i = 1; $i <= 5; $i++) {
    $ratings .= '<div href="/voxb/ajax/rating/' . $obj_id . "/" . $i . '" class="' . ($profile && $profile->isAbleToRate($faust_number) ? 'use-ajax' : '') . ' rating' . ($i <= $rating ? ' star-on' : ' star-off') . '"></div>';
  }

  $ratings .= '</div></div>';
  $ratings .= '<span class="rating-count-span">(<span class="rating-votes-number">' . (($voxb_item->getRatingCount() > 0) ? $voxb_item->getRatingCount() : 0) . '</span>)</span>';
  $ratings .= '<div class="ajax-anim">&nbsp;</div><div class="clearfix"></div>';


  // Reviews section
  $reviews = '';
  $limit = variable_get('voxb_reviews_per_page', VOXB_DEFAULT_REVIEWS_PER_PAGE);

  foreach ($voxb_item->getReviews('review') as $k => $v) {
    if ($k >= $limit) {
      break;
    }
    $reviews .= theme('voxb_review_record',
      array('author' => $v->getAuthorName(), 'review' => $v->getText())
    );
  }

  // Pagination section
  $pagination = '';
  $review_count = $voxb_item->getReviews('review')->getCount();
  $pages = -1;

  $pagination .= '<div id="pager-block" ' . (($review_count <= $limit) ? 'style="display: none;"' : '') . '>';
  $pagination .= '<ul>';
  // Hidden tab to keep track of first page
  $pagination .= '<li class="page-first" style="display: none;">' . l('', 'voxb/ajax/reviews/' . $obj_id . '/page/1', array('attributes' => array('class' => array('use-ajax')))) . '</li>';
  $pagination .= '<li class="prev-page">' . l('<<', 'voxb/ajax/reviews/' . $obj_id . '/page/1', array('attributes' => array('class' => array('use-ajax')))) . '</li>';

  $pages = ceil($review_count / variable_get('voxb_reviews_per_page', VOXB_DEFAULT_REVIEWS_PER_PAGE));

  // Draw 5 tabs/buttons/links
  for ($i = 0; $i < 5; $i++) {
    $pagination .= '<li class="page-num';
    // Highlight the middle one
    if ($i == 2) {
      $pagination .= '  active-page"';
    }

    $pagination .= '">';

    if ($i > 1 && $i < $pages + 2) {
      $pagination .= l(($i - 1), 'voxb/ajax/reviews/' . $obj_id . '/page/' . ($i - 1) . '', array('attributes' => array('class' => array('use-ajax'))));
    }
    else {
      $pagination .= '<a href="#"></a>';
    }

    $pagination .= '</li>';
  }

  $pagination .= '<li class="next-page">' . l('>>', 'voxb/ajax/reviews/' . $obj_id . '/page/2', array('attributes' => array('class' => array('use-ajax')))) . '</li>';
  $pagination .= '</ul>';
  $pagination .= '</div>';
  $pagination .= '<div class="clearfix"></div><br />';

  // Add review form section
  $review_form = '';
  $params = array();
  if ($profile) {
    // Form params, specific if user reviewed already or not
    $data = $profile->getVoxbUserData($obj_id);

    if ($data['review']['title'] != 'videoreview') {
      if ($data['review']['title'] == 'review') {
        $params = array(
          'faust_number' => $obj_id,
          'review_content' => $data['review']['data'],
          'action' => 'update',
        );
      }
      else {
        $params = array(
          'faust_number' => $obj_id,
          'review_content' => '',
          'action' => 'submit',
        );
      }

      $review_form .= drupal_render(drupal_get_form('ding_voxb_review_form', $params));
    }
  }

  // Add stuff to template
  $variables['tags'] = $tags;
  $variables['tags_form'] = $tags_form;
  $variables['ratings'] = $ratings;
  $variables['reviews'] = $reviews;
  $variables['pagination'] = $pagination;
  $variables['review_form'] = $review_form;
}

/**
 * Build the text review form
 *
 * @param $form
 *   The form and it's fields
 * @param $form_state
 *   Form state
 * @param $faustNumber
 *   Item's faust number, e.g. ID
 * @return
 *   Form structure
 */
function ding_voxb_review_form($form, &$form_state, $params) {
  $form['review_content'] = array(
    '#type' => 'textarea',
    '#default_value' => ($params['action'] == 'update') ? $params['review_content'] : '',
  );

  $form['faust_number'] = array(
    '#type' => 'hidden',
    '#value' => $params['faust_number'],
  );

  $form['review_submit'] = array(
    '#type' => 'submit',
    '#value' => ($params['action'] == 'submit') ? 'Review' : 'Update',
    '#ajax' => array(
      'callback' => 'ding_voxb_review_form_callback',
    ),
  );

  return $form;
}

/**
 * Callback function for text review
 *
 * @param $form
 *   The form and it's fields
 * @param $form_state
 *   Form state
 * @return
 *   Array of json commands
 */
function ding_voxb_review_form_callback($form, &$form_state) {
  $commands = array();

  /**
   * Check if we have review message and faustNumber
   */
  if (empty($form['review_content']['#value'])) {
    $commands[] = ajax_command_ding_popup('add_review_error', t('Error'), t('Please fill in your review message.'));
  }
  elseif (empty($form['faust_number']['#value'])) {
    $commands[] = ajax_command_ding_popup('add_review_error', t('Error'), t('Wrong or empty faust number.'));
  }
  else {

    // add review to to voxb
    $review = new VoxbReviewRecord();

    $profile = unserialize($_SESSION['voxb']['profile']);

    if (!$review->create($form['faust_number']['#value'], $form['review_content']['#value'], $profile)) {
      // add ding_popup command with notice message
      $commands[] = ajax_command_ding_popup('voxb_error', t('Error'), t('Service temporary unavailable.'));
    }
    else {
      // update profile object in session
      $profile->updateActedItems();
      $_SESSION['voxb']['profile'] = serialize($profile);

      // add commands to hide review container and show 'thank' message
      $commands[] = ajax_command_html('.user-reviews', '');
      $commands[] = ajax_command_invoke('#edit-review-submit', 'val', array('Update'));
      $commands[] = ajax_command_invoke('.add-video-review-container', 'hide', array());

      // Get reviews updated list

      $item = new VoxbItem();
      $item->addReviewHandler('review', new VoxbReviews());
      $item->fetchByFaust($form['faust_number']['#value']);
      $reviews = $item->getReviews('review');
      $reviews_count = $reviews->getCount();

      // Limit the count of displayed text reviews
      $limit = variable_get('voxb_reviews_per_page', VOXB_DEFAULT_REVIEWS_PER_PAGE);

      // Loop through reviews and display them
      foreach ($reviews as $k => $review) {
        if ($k >= $limit) {
          break;
        }

        $commands[] = ajax_command_prepend('.user-reviews', theme(
          'voxb_review_record',
          array(
            'author' => $review->getAuthorName(),
            'review' => $review->getText())
          )
        );
      }

      if ($reviews_count > $limit) {
        $commands[] = ajax_command_invoke('#pager-block', 'show');
      }
      // Jump to the first page
      if ($reviews_count > $limit) {
        $commands[] = ajax_command_invoke('.page-first a', 'click');
      }
    }
  }

  return array('#type' => 'ajax', '#commands' => $commands);
}

/**
 * Create form for adding tags.
 *
 * @param $form
 *   Form structure
 * @param $form_state
 *   Form state
 * @param $faust_number
 *   Item ID
 */
function ding_voxb_tag_form($form, $form_state, $faust_number) {
  $form['name'] = array(
    '#type' => 'textfield',
    '#size' => 20,
    '#name' => 'name',
    '#ajax' => array(
      'event' => 'submit',
      'keypress' => TRUE,
      'callback' => 'ding_voxb_add_tag_callback'
    )
  );

  $form['faustNumber'] = array(
    '#type' => 'hidden',
    '#name' => 'faustNumber',
    '#value' => $faust_number
  );

  $form['submit'] = array(
    '#type' => 'submit',
    '#value' => t('Submit'),
    '#ajax' => array(
      'callback' => 'ding_voxb_add_tag_callback'
    ),
    '#attributes' => array('class' => array('rounded-corners')),
  );

  return $form;
}

/**
 * Callback method to handle add tag calls.
 *
 * @param $form
 *   Form structure
 * @param $form_state
 *   Form state
 * @return
 *   Array of JSON commands
 */
function ding_voxb_add_tag_callback($form, &$form_state) {
  $commands = array();

  if (empty($form['name']['#value'])) {
    $commands[] = ajax_command_ding_popup('add_tag_error', t('Error'), t('Please fill in your tag.'));
  }
  else {
    $tag = new VoxbTagRecord();
    $profile = unserialize($_SESSION['voxb']['profile']);

    if (!$tag->create($form['faustNumber']['#value'], $form['name']['#value'], $profile)) {
      // add popup notice
      $commands[] = ajax_command_ding_popup('voxb_error', t('Error'), t('Service temporary unavailable.'));
    }
    else {
      // update profile object in session
      $profile->updateActedItems();
      $_SESSION['voxb']['profile'] = serialize($profile);

      // hide form and show new tag
      $commands[] = ajax_command_append('div.record-tag-highlight', theme('voxb_tag_record', array('tag_name' => $form['name']['#value'])));
      $commands[] = array(
        'command' => 'voxb_tag_callback',
      );
    }
  }
  return array('#type' => 'ajax', '#commands' => $commands);
}

/**
 * Callback function for item rating.
 *
 * @param $type
 *   Type of request
 * @param $faust_number
 *   Item ID
 * @param $rating
 *   Item rating
 */
function ding_voxb_rating($type = 'ajax', $faust_number = NULL, $rating = 0) {
   // We check if it's an ajax call
   // this can be used if we will ipmlement NO-JS functionality in FE.
  if ($type == 'ajax') {
    $commands = array();
    $rating = intval($rating);

    if ($rating == 0) {
      $commands[] = ajax_command_ding_popup('add_rate_error', t('Error'), t('Nothing selected.'));
    }
    elseif (empty($faust_number)) {
      $commands[] = ajax_command_ding_popup('add_rate_error', t('Error'), t('Wrong or empty faust number.'));
    }
    else {
      $item = new VoxbItem();

      $profile = unserialize($_SESSION['voxb']['profile']);
      $record_id = $profile->getVoxbUserData($faust_number);
      $r = NULL;

      if ($record_id == NULL) {
        $r = $item->rateItem($faust_number, $rating * 20, $_SESSION['voxb']['userId']);
      }
      else {
        $r = $item->updateRateItem($record_id['voxbIdentifier'], $rating * 20);
        // update profile object in session
      }
      $profile->updateActedItems();
      $_SESSION['voxb']['profile'] = serialize($profile);

      if ($r) {
        // Rating is successfully submited
        // Now we need to fetch new rating form Voxb
        $item->fetchByFaust($faust_number);

        $commands[] = array(
          'command' => 'voxb_rating_callback',
          'rating' => intval($item->getRating() / 20),
          'rating_count' => $item->getRatingCount()
        );
      }
      else {
        $commands[] = ajax_command_ding_popup('voxb_error', t('Error'), t('Service temporary unavailable.'));
      }
    }

    $commands[] = ajax_command_invoke('.ratings-container .ajax-anim', 'hide', array());

    $result = array('#type' => 'ajax', '#commands' => $commands);
    ajax_deliver($result);
  }
}

/**
 * Implements MODULE_ctools_plugin_directory().
 *
 * Tell chaos tools where plugins are.
 */
function ding_voxb_ctools_plugin_directory($module, $plugin) {
  if ($module == 'ctools') {
    return 'plugins/' . $plugin;
  }
}

/**
 * Implements MODULE_ding_entity_view().
 *
 * Enrich ting object data array with voxb stuff.
 */
function ding_voxb_ding_entity_view($entity, $view_mode, $langcode = NULL) {
  global $js_added;
  // Show only on full item page
  if ($view_mode == 'full') {
    // Ting object local id
    $oid = explode(':', $entity->ding_entity_id);
    $oid = $oid[1];

    $entity->content['voxb'] = array(
      '#markup' => theme('voxb', array('object_id' => $oid)),
      '#weight' => '10'
    );
  }
  elseif($view_mode == 'teaser') {
    if (!$js_added) {
      drupal_add_js(VOXB_PATH . '/js/voxb.details.js', 'file');
      $js_added = TRUE;
    }
  }
}

/**
 * Implements MODULE_ding_devel_timers().
 */
function ding_voxb_ding_devel_timers() {
  return array(
    'voxb' => array(
      'title' => 'VoxB total request time was @time ms.',
    )
  );
}

/**
 * Request rating and review count for multiple items
 *
 * @param $items
 *   Array of faust numbers
 * @return
 *   JSON encoded response
 *   In format item:faust, rating:count, reviews:count
 */
function ding_voxb_details() {
  $request = $_REQUEST['items'];

  $voxb = new VoxbItem();
  $voxb->fetchByFaust($request, TRUE);

  //echo json_encode($request);
}
